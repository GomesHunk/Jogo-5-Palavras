<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jogo das 5 Palavras - Final</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:400,500,600,700&display=swap">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0;}
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #6a82fb, #fc5c7d);
      color: #333; min-height: 100vh;
      display: flex; flex-direction: column; align-items: center;
      padding: 10px; font-size: 16px; 
    }
    .container { max-width: 1200px; width: 100%; }
    .section {
      background: rgba(255, 255, 255, 0.97); 
      backdrop-filter: blur(3px); 
      border-radius: 12px; 
      padding: 20px; margin-bottom: 20px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }
    .hidden { display: none !important; }
    h1, h2, h3 { color: #4a5568; text-align: center; font-weight: 600; }
    h1 { margin-bottom: 25px; font-size: 2.2em; color: white; text-shadow: 1px 1px 3px rgba(0,0,0,0.25); }
    h2 { margin-bottom: 20px; font-size: 1.6em; }
    h3 { margin-bottom: 15px; font-size: 1.25em; color: #5a67d8; }

    .game-layout { display: grid; grid-template-columns: 1fr; gap: 20px; align-items: start; }
    @media (min-width: 800px) { .game-layout { grid-template-columns: 1fr 340px; } }

    .game-main { min-height: 350px; }
    .game-sidebar { display: flex; flex-direction: column; gap: 15px; }
    .sidebar-section { padding: 15px; background-color: rgba(255,255,255,0.9); border-radius: 8px; }
    .sidebar-section h3 { margin: 0 0 10px 0; font-size: 1.15em; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px; }

    .player-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 12px; margin: 6px 0; background: #f8fafc;
      border-radius: 8px; font-size: 0.95em; border-left: 4px solid transparent;
      transition: background-color 0.2s;
    }
    .player-name { font-weight: 500; }
    .player-status { display: flex; gap: 8px; align-items: center; font-size: 0.9em;}
    .status-icon { font-size: 1.1em; } 
    .player-item.current-turn { border-left-color: #48bb78; background-color: #f0fff4; }

    .chat-messages {
      height: 180px; overflow-y: auto; border: 1px solid #e2e8f0;
      border-radius: 8px; padding: 12px; background: #fff;
      font-size: 0.9em; margin-bottom: 12px;
    }
    .chat-message { margin-bottom: 10px; line-height: 1.5; }
    .chat-timestamp { color: #a0aec0; font-size: 0.8em; margin-right: 6px; }
    .chat-player { font-weight: 600; color: #7f5af0; }

    .input-button-group { display: flex; gap: 8px; align-items: stretch; }
    .input-field {
      flex-grow: 1; padding: 10px 14px; border: 1px solid #cbd5e0;
      border-radius: 8px; font-size: 1em; min-width: 0; direction: ltr; 
    }
    .action-button {
      flex-shrink: 0; padding: 10px 15px; background: #7f5af0; color: white;
      border: none; border-radius: 8px; cursor: pointer; font-size: 1em; 
      font-weight: 500; white-space: nowrap; transition: background-color 0.2s;
    }
    .action-button:hover { background: #6c47d8; }
    .action-button.success { background: #48bb78; }
    .action-button.success:hover { background: #38a169; }


    label { display: block; width: 100%; margin-bottom: 6px; font-weight: 600; font-size: 0.95em; color: #4a5568; }
    input[type="text"].form-input { /* Classe espec√≠fica para inputs de formul√°rio */
      width: 100%; padding: 12px 15px; border: 1px solid #cbd5e0;
      border-radius: 8px; margin-bottom: 18px; font-size: 1em; color: #2d3748;
    }
    input[type="text"].form-input:focus { border-color: #7f5af0; box-shadow: 0 0 0 3px rgba(127, 90, 240, 0.2); outline: none;}

    button.general-button { /* Para bot√µes que n√£o s√£o parte de input-button-group */
      background: #7f5af0; color: white; font-weight: 600; 
      border: none; padding: 12px 20px; border-radius: 8px;
      cursor: pointer; transition: background 0.2s, transform 0.1s;
      width: 100%; margin-bottom: 12px; font-size: 1em; text-transform: uppercase; letter-spacing: 0.5px;
    }
    button.general-button:hover { background: #6c47d8; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    button.general-button:active { transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    button.general-button.secondary { background: #a0aec0; }
    button.general-button.secondary:hover { background: #718096; }
    button.general-button.success { background: #48bb78; }
    button.general-button.success:hover { background: #38a169; }
    button.general-button.warning { background: #ecc94b; color: #2d3748; }
    button.general-button.warning:hover { background: #d69e2e; }

    .options-grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin-bottom: 20px; }
     @media (min-width: 480px) { .options-grid { grid-template-columns: 1fr 1fr; } }

    .room-code-display {
      background: rgba(230, 237, 255, 0.8); border: 2px dashed #7f5af0; padding: 25px;
      text-align: center; border-radius: 10px; margin: 25px 0;
    }
    .room-code-value {
      font-size: 2em; font-weight: 700; color: #6c47d8; letter-spacing: 3px;
      background: white; padding: 12px 22px; border-radius: 8px; display: inline-block;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin: 8px 0 15px 0;
    }
    button.copy-code-btn { background: #38b2ac; margin: 0 auto; max-width: 200px; font-size: 0.9em; padding: 10px;}
    button.copy-code-btn:hover { background: #2c7a7b; }

    .game-info { text-align: center; margin-bottom: 20px; }
    .turn-info { font-size: 1.4em; font-weight: 600; color: #6c47d8; margin-bottom: 18px; }
    .turn-info .active-player-name { font-weight: 700; color: #5a67d8; }
    
    .keyword-initials-display {
        background-color: rgba(240, 244, 255, 0.8); 
        padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: left; 
        border: 1px solid #d6ddeb;
    }
    .keyword-initials-display p { margin: 8px 0; font-size: 1.1em; color: #2d3748; line-height: 1.5;}
    .keyword-initials-display .keyword-label { font-weight: 600; color: #5a67d8; }
    .keyword-initials-display .initial-letter {
      display: inline-block; background-color: #e2e8f0; color: #4a5568;
      padding: 6px 10px; border-radius: 6px; font-weight: 600; margin: 0 4px;
      min-width: 32px; text-align: center; font-size: 1em;
    }
    .keyword-initials-display .main-keyword {
      font-weight: 700; font-size: 1.15em; color: #7f5af0; background-color: white;
      padding: 5px 10px; border-radius: 6px;
    }

    .word-progress-container {
        display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; 
        margin-bottom: 25px; padding: 10px 0;
    }
    .word-slot {
      background-color: #edf2f7; color: #718096; padding: 12px 18px; 
      border-radius: 8px; font-size: 1.2em; font-weight: 600;
      min-width: 55px; text-align: center; border: 2px solid #e2e8f0;
      transition: all 0.3s ease;
    }
    .word-slot.revealed-keyword { background-color: #ebf4ff; color: #4299e1; border-color: #90cdf4; font-weight: 700; }
    .word-slot.completed { background-color: #f0fff4; color: #38a169; border-color: #68d391; font-weight: 700; }
    .word-slot.is-active-hint { border-color: #7f5af0; box-shadow: 0 0 0 2px rgba(127, 90, 240, 0.4); }

    .hint-display {
      font-size: 2em; font-family: monospace; background: white; padding: 18px; 
      border-radius: 10px; border: 2px solid #e2e8f0; letter-spacing: 4px; 
      margin: 15px auto 25px auto; color: #2d3748; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      max-width: fit-content; /* Para centralizar o conte√∫do do hint */
    }
    
    .word-inputs-container input[type="text"].form-input { margin-bottom: 12px; } /* Ajuste da classe */

    .waiting-screen { text-align: center; padding: 35px 20px; }
    .waiting-animation { font-size: 2.8em; margin: 18px 0; animation: pulse 1.8s infinite ease-in-out; }
    @keyframes pulse { 0%, 100% { opacity: 0.7; transform: scale(0.98);} 50% { opacity: 1; transform: scale(1.02);}}

    #game-finished-display { margin-top: 20px; text-align: center; }
    #game-finished-message { font-weight: 600; margin-bottom: 18px; font-size: 1.1em; line-height: 1.6; }
    #new-game-button-container { margin-top: 25px; display: flex; flex-direction: column; gap: 10px; align-items: center;}
    #new-game-button-container button { width: auto; min-width: 200px; }


    .toast-notification {
      position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px;
      color: white; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000; opacity: 0; transform: translateX(100%);
      transition: opacity 0.3s ease, transform 0.3s ease; min-width: 250px; text-align: center;
    }
    .toast-notification.show { opacity: 1; transform: translateX(0); }
    .toast-notification.success { background: #48bb78; }
    .toast-notification.error { background: #f56565; }
    .toast-notification.info { background: #4299e1; }


    @media (max-width: 800px) { /* Ajuste breakpoint para sidebar */
      .game-sidebar { order: 1; /* Sidebar abaixo do jogo principal */ }
    }
    @media (max-width: 480px) {
      .section { padding: 18px 12px; } 
      h1 { font-size: 1.8em; }
      .room-code-value { font-size: 1.5em; letter-spacing: 2px; }
      .hint-display {font-size: 1.6em; padding: 15px; }
      .word-slot { font-size: 1em; padding: 10px 12px; min-width: 40px;}
      .keyword-initials-display p { font-size: 1em; }
      .keyword-initials-display .initial-letter { padding: 5px 8px; min-width: 28px; font-size: 0.9em; }
      .keyword-initials-display .main-keyword { font-size: 1.05em; }

      .input-button-group { flex-direction: column; gap: 10px; }
      .input-field, .action-button { width: 100%; }
      .action-button { padding: 12px; font-size: 1em;}
      button.general-button, button.copy-code-btn { font-size: 0.95em; padding: 12px 15px;}
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéØ Jogo das 5 Palavras</h1>

    <div class="section" id="initial-section">
      <h2>Como deseja jogar?</h2>
      <div class="options-grid">
        <button class="general-button success" onclick="showScreen('create-room-section')">üè† Criar Nova Sala</button>
        <button class="general-button warning" onclick="showScreen('join-room-section')">üîë Entrar em Sala</button>
      </div>
    </div>

    <div class="section hidden" id="create-room-section">
      <button class="general-button secondary" onclick="handleGoBackToInitial()">‚Üê Voltar</button>
      <h2>Criar Nova Sala</h2>
      <label for="create-player-name">Seu Nome:</label>
      <input type="text" id="create-player-name" class="form-input" placeholder="Seu nome aqui..." maxlength="20" />
      <button class="general-button" onclick="createRoom()">Criar Sala</button>
      <div id="room-created-info" class="hidden">
        <div class="room-code-display">
          <h3>üéâ Sala Criada!</h3>
          <p>Compartilhe este c√≥digo com seu amigo:</p>
          <div class="room-code-value" id="generated-room-code">C√ìDIGO</div>
          <button class="general-button copy-code-btn" onclick="copyRoomCode()">üìã Copiar C√≥digo</button>
        </div>
        <div class="waiting-screen">
          <div class="waiting-animation">‚è≥</div>
          <p><strong>Aguardando outro jogador...</strong></p>
        </div>
      </div>
    </div>

    <div class="section hidden" id="join-room-section">
      <button class="general-button secondary" onclick="handleGoBackToInitial()">‚Üê Voltar</button>
      <h2>Entrar em Sala</h2>
      <label for="join-player-name">Seu Nome:</label>
      <input type="text" id="join-player-name" class="form-input" placeholder="Seu nome aqui..." maxlength="20" />
      <label for="join-room-code">C√≥digo da Sala:</label>
      <input type="text" id="join-room-code" class="form-input" placeholder="C√≥digo de 6 d√≠gitos" maxlength="6" style="text-transform: uppercase;" />
      <button class="general-button" onclick="joinExistingRoom()">Entrar na Sala</button>
    </div>

    <div class="section hidden" id="word-selection-section">
      <button class="general-button secondary" onclick="handleLeaveGameDuringSetup()" style="width:auto; float:left; font-size:0.8em; padding: 8px 12px;">Sair</button>
      <h2 style="clear:both;">Escolha suas 5 palavras</h2>
      <p>As palavras devem ter conex√£o sem√¢ntica em sequ√™ncia. (M√≠n 2, M√°x 25 caracteres)</p>
      <div id="word-inputs-container" class="word-inputs-container"></div>
      <button id="submit-words-button" class="general-button" onclick="submitWords()">Enviar Palavras</button>
      <div id="waiting-for-opponent-words" class="waiting-screen hidden">
        <div class="waiting-animation">üí¨</div>
        <p><strong>Palavras enviadas! Aguardando oponente...</strong></p>
      </div>
    </div>

    <div class="game-layout hidden" id="game-screen-layout">
      <div class="game-main">
        <div class="section" id="game-active-section">
           <button class="general-button secondary" id="leave-active-game-button" onclick="handleLeaveActiveGame()" style="width: auto; float: right; margin-bottom: 10px; font-size: 0.8em; padding: 8px 12px;">Sair</button>
          <div class="game-info" style="clear:both;">
            <div class="turn-info" id="turn-info-display">Carregando turno...</div>
            <div id="keyword-initials-display" class="keyword-initials-display"></div>
            <div id="word-progress-container" class="word-progress-container"></div>
            <div class="hint-display" id="current-hint-display">_ _ _ _ _</div>
          </div>
          <div class="input-button-group" id="guess-input-group">
            <input type="text" id="guess-input" class="input-field" placeholder="Seu palpite..." disabled />
            <button onclick="sendGuess()" class="action-button success" id="guess-button" disabled>Enviar Palpite</button>
          </div>
          <div id="game-finished-display" class="hidden">
            <h3 id="game-finished-message">Jogo Finalizado!</h3>
            <div id="new-game-button-container">
              <button class="general-button warning" onclick="requestNewGame()">‚ú® Jogar Novamente</button>
              <button class="general-button secondary" onclick="handleGoBackToInitial()">Voltar ao Menu</button>
            </div>
          </div>
        </div>
      </div>
      <div class="game-sidebar">
        <div class="sidebar-section">
          <h3>üë• Jogadores</h3>
          <div id="players-list"></div>
        </div>
        <div class="sidebar-section">
          <h3>üí¨ Chat</h3>
          <div class="chat-messages" id="chat-messages-box"></div>
          <div class="input-button-group" id="chat-input-group">
            <input type="text" id="chat-message-input" class="input-field" placeholder="Mensagem..." maxlength="100" />
            <button onclick="sendChatMessage()" class="action-button" id="chat-send-button">Enviar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
    const socket = io(); 
    let currentPlayerName = '';
    let currentRoomId = '';
    const NUM_WORDS_TOTAL = 5; 

    const allScreenIds = [
      "initial-section", "create-room-section", "join-room-section",
      "word-selection-section", "game-screen-layout"
    ];
    function showScreen(screenIdToShow) {
      allScreenIds.forEach(id => {
        const el = document.getElementById(id);
        if(el) el.classList.add("hidden");
      });
      const screenEl = document.getElementById(screenIdToShow);
      if(screenEl) screenEl.classList.remove("hidden");
      
      if (screenIdToShow === 'create-room-section') { 
        const roomInfoEl = document.getElementById('room-created-info');
        if(roomInfoEl) roomInfoEl.classList.add('hidden');
        const createNameEl = document.getElementById('create-player-name');
        if(createNameEl) createNameEl.value = '';
      } else if (screenIdToShow === 'join-room-section') {
        const joinNameEl = document.getElementById('join-player-name');
        const joinCodeEl = document.getElementById('join-room-code');
        if(joinNameEl) joinNameEl.value = '';
        if(joinCodeEl) joinCodeEl.value = '';
      }
      const finishedDispEl = document.getElementById('game-finished-display');
      if(finishedDispEl) finishedDispEl.classList.add('hidden'); 
    }

    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast-notification ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => { toast.classList.add('show'); }, 10);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => { if (toast.parentNode) toast.parentNode.removeChild(toast); }, 350);
        }, 3000 + (message.length * 30)); // Dura um pouco mais para mensagens longas
    }

    function copyRoomCode() {
      const roomCodeEl = document.getElementById("generated-room-code");
      if(!roomCodeEl) return;
      const roomCode = roomCodeEl.textContent;
      navigator.clipboard.writeText(roomCode)
        .then(() => showToast("C√≥digo copiado! üìã", "success"))
        .catch(() => showToast("Erro ao copiar. C√≥digo: " + roomCode, "error"));
    }
    
    function resetLocalGameState(){
        currentRoomId = '';
        currentPlayerName = ''; // Poderia manter se quisesse preencher automaticamente
        const playersListEl = document.getElementById("players-list");
        const chatBoxEl = document.getElementById("chat-messages-box");
        const wordProgressEl = document.getElementById("word-progress-container");
        const keywordInitialsEl = document.getElementById("keyword-initials-display");
        const currentHintEl = document.getElementById("current-hint-display");

        if(playersListEl) playersListEl.innerHTML = "";
        if(chatBoxEl) chatBoxEl.innerHTML = "";
        if(wordProgressEl) wordProgressEl.innerHTML = "";
        if(keywordInitialsEl) keywordInitialsEl.innerHTML = "";
        if(currentHintEl) currentHintEl.textContent = "_ _ _ _ _";

        document.getElementById('game-finished-display')?.classList.add('hidden');
    }

    function handleGoBackToInitial() {
        if (currentRoomId) { // Se estava em uma sala, emite evento de sa√≠da
            socket.emit("player_initiated_leave");
        }
        resetLocalGameState();
        showScreen('initial-section');
    }
    
    function handleLeaveGameDuringSetup(){ // Usado na tela de escolha de palavras
        if(currentRoomId){ 
            socket.emit("player_initiated_leave");
        }
        resetLocalGameState();
        showScreen('initial-section');
    }
    function handleLeaveActiveGame(){ // Usado durante o jogo ativo
        if (currentRoomId && confirm("Tem certeza que deseja sair da partida? Isso encerrar√° o jogo para o oponente.")) {
            socket.emit("player_initiated_leave");
            resetLocalGameState();
            showScreen('initial-section');
        }
    }

    function createRoom() {
      currentPlayerName = document.getElementById("create-player-name").value.trim();
      if (!currentPlayerName || currentPlayerName.length < 2 || currentPlayerName.length > 20) {
        showToast("Nome inv√°lido (2-20 caracteres).", "error"); return;
      }
      socket.emit("join_game", { player_name: currentPlayerName });
    }

    function joinExistingRoom() {
      currentPlayerName = document.getElementById("join-player-name").value.trim();
      currentRoomId = document.getElementById("join-room-code").value.trim().toUpperCase();
      if (!currentPlayerName || currentPlayerName.length < 2 || currentPlayerName.length > 20) {
        showToast("Nome inv√°lido (2-20 caracteres).", "error"); return;
      }
      if (!currentRoomId || currentRoomId.length !== 6) { 
        showToast("C√≥digo da sala inv√°lido (6 caracteres).", "error"); return;
      }
      socket.emit("join_game", { player_name: currentPlayerName, room_id: currentRoomId });
    }

    function createWordInputFields() {
      const container = document.getElementById("word-inputs-container");
      container.innerHTML = '';
      for (let i = 0; i < NUM_WORDS_TOTAL; i++) {
        const input = document.createElement("input");
        input.type = "text";
        input.classList.add("form-input"); // Usa a classe para inputs de formul√°rio
        input.placeholder = `Palavra ${i + 1}`;
        input.id = `word-input-${i}`;
        input.maxLength = 25; 
        container.appendChild(input);
      }
    }

    function submitWords() {
      const words = [];
      const submitBtn = document.getElementById("submit-words-button");
      for (let i = 0; i < NUM_WORDS_TOTAL; i++) {
        const wordEl = document.getElementById(`word-input-${i}`);
        if(!wordEl) { showToast(`Erro: Input para palavra ${i+1} n√£o encontrado.`, "error"); return; }
        const word = wordEl.value.trim();
        if (!word || word.length < 2 || word.length > 25) {
          showToast(`Palavra ${i+1} inv√°lida (2-25 caracteres).`, "error"); return;
        }
        words.push(word);
      }
      socket.emit("submit_words", { words });
      document.getElementById("waiting-for-opponent-words")?.classList.remove("hidden");
      if(submitBtn) submitBtn.disabled = true; 
    }

    function sendGuess() {
      const guessInputEl = document.getElementById("guess-input");
      if(!guessInputEl) return;
      const guess = guessInputEl.value.trim();
      if (!guess) { showToast("Digite um palpite!", "info"); return; }
      socket.emit("make_guess", { guess });
      guessInputEl.value = "";
    }
    
    function sendChatMessage() {
      const msgInputEl = document.getElementById("chat-message-input");
      if(!msgInputEl) return;
      const message = msgInputEl.value.trim();
      if (message && message.length <= 150) {
        socket.emit("chat_message", { message });
        msgInputEl.value = "";
      } else if (message.length > 150) {
        showToast("Mensagem muito longa (m√°x 150 caracteres).", "error");
      }
    }
    function addMessageToChat(playerName, message, timestamp) {
        const chatBox = document.getElementById("chat-messages-box");
        if(!chatBox) return;
        const msgDiv = document.createElement("div");
        msgDiv.classList.add("chat-message");
        
        const timeSpan = document.createElement("span");
        timeSpan.className = "chat-timestamp";
        timeSpan.textContent = `[${timestamp}]`;
        
        const playerSpan = document.createElement("span");
        playerSpan.className = "chat-player";
        playerSpan.textContent = `${playerName}: `;
        
        msgDiv.appendChild(timeSpan);
        msgDiv.appendChild(playerSpan);
        msgDiv.appendChild(document.createTextNode(message)); // Usar textContent para seguran√ßa
        
        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
    
    function requestNewGame() { 
        socket.emit("request_new_game", {});
        document.getElementById('game-finished-display')?.classList.add('hidden'); 
    }

    function renderKeywordAndInitialsSharedView(viewingForPlayer, keyword, initialsArray) {
        const display = document.getElementById("keyword-initials-display");
        if (!display) return;
        let html = `<p><span class="keyword-label">Palavra Chave de <span class="active-player-name">${viewingForPlayer}</span>:</span> <span class="main-keyword">${keyword.toUpperCase()}</span></p>`;
        if (initialsArray && initialsArray.length > 0) {
            html += `<p><span class="keyword-label">Pr√≥ximas Iniciais:</span> `;
            initialsArray.forEach(initial => {
                html += `<span class="initial-letter">${initial.toUpperCase()}</span>`;
            });
            html += `</p>`;
        }
        display.innerHTML = html;
    }

    function renderWordProgressSlotsSharedView(allOriginalTargetWords, completedMask, activeWordIdxBeingGuessed) {
        const container = document.getElementById("word-progress-container");
        if (!container || !allOriginalTargetWords) return;
        container.innerHTML = ""; 

        allOriginalTargetWords.forEach((word, index) => {
            const slot = document.createElement("div");
            slot.classList.add("word-slot");

            if (index === 0) { 
                slot.textContent = word.toUpperCase();
                slot.classList.add("revealed-keyword"); 
            } else if (completedMask[index]) { 
                slot.textContent = word.toUpperCase();
                slot.classList.add("completed");
            } else { 
                slot.textContent = word[0].toUpperCase(); // Apenas a inicial
            }
            
            if (index === activeWordIdxBeingGuessed && index !== 0 && !completedMask[index]) {
                slot.classList.add("is-active-hint");
            }
            container.appendChild(slot);
        });
    }

    function updateTurnDisplayAndInputsSharedView(isClientTurn, turnPlayerNameStr) {
        const turnInfoEl = document.getElementById("turn-info-display");
        const guessInputEl = document.getElementById("guess-input");
        const guessButtonEl = document.getElementById("guess-button");

        if (!turnInfoEl || !guessInputEl || !guessButtonEl) return;
        
        const actualTurnPlayerName = turnPlayerNameStr || "Oponente";

        if (isClientTurn) {
            turnInfoEl.innerHTML = `üéØ √â a sua vez, <span class="active-player-name">${currentPlayerName}</span>!`;
            turnInfoEl.style.color = "#48bb78";
            guessInputEl.disabled = false;
            guessButtonEl.disabled = false;
            setTimeout(() => guessInputEl.focus(), 100);
        } else {
            turnInfoEl.innerHTML = `Aguardando <span class="active-player-name">${actualTurnPlayerName}</span>...`;
            turnInfoEl.style.color = "#a0aec0";
            guessInputEl.disabled = true;
            guessButtonEl.disabled = true;
        }
    }

    socket.on("connected", () => showToast("Conectado ao servidor!", "success"));
    socket.on("error", (data) => showToast(data.message || "Erro desconhecido do servidor.", "error"));

    socket.on("joined_room", (data) => {
      currentRoomId = data.room_id;
      // currentPlayerName j√° foi definido ao criar/entrar na sala
      showToast(`Entrou na sala: ${data.room_id}`, "success");
      if (data.is_creator) {
        document.getElementById("generated-room-code").textContent = data.room_id;
        document.getElementById("room-created-info")?.classList.remove("hidden");
      }
    });

    socket.on("players_update", (data) => {
      const playersListEl = document.getElementById("players-list");
      if(!playersListEl) return;
      playersListEl.innerHTML = "";
      data.players_online.forEach(p => {
        const item = document.createElement("div");
        item.className = "player-item";
        if (p.is_current_turn) item.classList.add("current-turn");
        item.innerHTML = `
          <span class="player-name">${p.name} ${p.name === currentPlayerName ? "<small>(Voc√™)</small>" : ""}</span>
          <span class="player-status">
            ${p.is_current_turn ? '<span class="status-icon" title="Vez dele(a)">üëâ</span>' : ''}
            ${p.words_chosen ? '<span class="status-icon" title="Palavras Prontas">‚úÖ</span>' : '<span class="status-icon" title="Escolhendo Palavras">üìù</span>'}
          </span>`;
        playersListEl.appendChild(item);
      });
    });
    
    socket.on("start_choosing_words", (data) => {
        resetLocalGameState(); // Limpa qualquer estado de jogo anterior
        currentRoomId = currentRoomId; // Mant√©m o room ID se j√° estiver definido
        // currentPlayerName j√° deve estar definido
        showScreen('word-selection-section');
        createWordInputFields();
        const waitingMsgEl = document.getElementById("waiting-for-opponent-words");
        const submitBtnEl = document.getElementById("submit-words-button");
        if(waitingMsgEl) waitingMsgEl.classList.add("hidden");
        if(submitBtnEl) submitBtnEl.disabled = false;
        if(data.message) showToast(data.message, "info");
    });

    socket.on("words_submitted_update", (data) => { 
        showToast(`${data.player_name} enviou as palavras.`, "info");
        // Atualiza a lista de jogadores para refletir o status 'words_chosen'
        const playersListEl = document.getElementById("players-list");
        if(!playersListEl) return;
        playersListEl.innerHTML = ""; 
         data.players_online.forEach(p => {
            const item = document.createElement("div");
            item.className = "player-item";
            if (p.is_current_turn) item.classList.add("current-turn");
            item.innerHTML = `
            <span class="player-name">${p.name} ${p.name === currentPlayerName ? "<small>(Voc√™)</small>" : ""}</span>
            <span class="player-status">
                ${p.is_current_turn ? '<span class="status-icon" title="Vez dele(a)">üëâ</span>' : ''}
                ${p.words_chosen ? '<span class="status-icon" title="Palavras Prontas">‚úÖ</span>' : '<span class="status-icon" title="Escolhendo Palavras">üìù</span>'}
            </span>`;
            playersListEl.appendChild(item);
        });
    });

    socket.on("update_game_display", (data) => {
        if (!data) { console.error("update_game_display: Dados ausentes."); return; }
        showScreen('game-screen-layout'); 
        document.getElementById('game-finished-display')?.classList.add('hidden');

        renderKeywordAndInitialsSharedView(
            data.viewing_for_player_name,
            data.keyword_to_display,
            data.initials_to_display
        );
        renderWordProgressSlotsSharedView(
            data.all_target_words_original_for_progress,
            data.completed_mask_for_progress,
            data.active_word_idx_being_guessed
        );
        document.getElementById("current-hint-display").textContent = data.current_hint || "---";
        updateTurnDisplayAndInputsSharedView(data.is_your_turn, data.actual_current_turn_player_name);

        if (data.last_action_result) {
            const action = data.last_action_result;
            if (action.type === "correct_guess") {
                showToast(`${action.by_player_name} acertou "${action.word}"!`, "success");
            } else if (action.type === "incorrect_guess") {
                showToast(`${action.by_player_name} errou com "${action.attempted_word}". Vez de ${data.actual_current_turn_player_name || 'Oponente'}.`, "info");
            } else if (action.type === "game_start") {
                 showToast("O jogo come√ßou! Boa sorte!", "success");
            }
        }
    });
    
    socket.on("game_finished", (data) => {
        showToast(data.message, data.winner_name === currentPlayerName ? "success" : "info");
        let finishMsg = data.message;
        if (data.final_words_sequence && data.final_words_sequence.length > 0 && !data.was_disconnection) {
            finishMsg += ` Sequ√™ncia adivinhada: ${data.final_words_sequence.join(' ‚Üí ')}`;
        }
        document.getElementById("game-finished-message").textContent = finishMsg;
        document.getElementById("game-finished-display")?.classList.remove("hidden");
        
        const guessInputEl = document.getElementById("guess-input");
        const guessButtonEl = document.getElementById("guess-button");
        if(guessInputEl) guessInputEl.disabled = true;
        if(guessButtonEl) guessButtonEl.disabled = true;
        
        const hintDispEl = document.getElementById("current-hint-display");
        if(hintDispEl) hintDispEl.textContent = "FIM DE JOGO";
    });
    
    socket.on("opponent_left_game", (data) => { 
        showToast(data.message || `${data.leaver_name} saiu.`, "warning");
        // game_finished deve tratar o final do jogo se o oponente saiu e resultou em W.O.
    });

    socket.on("game_reset_initiated", (data) => { 
        showToast(data.message || "Novo jogo iniciado!", "info");
        // A tela ser√° trocada por "start_choosing_words"
        document.getElementById('game-finished-display')?.classList.add('hidden');
    });
    socket.on("new_chat_message", (data) => { 
      addMessageToChat(data.player_name, data.message, data.timestamp);
    });

    document.addEventListener("keypress", function(event) {
      if (event.key === "Enter") {
        const activeElement = document.activeElement;
        if(!activeElement) return;
        if (activeElement.id === "chat-message-input") sendChatMessage();
        else if (activeElement.id === "guess-input" && !activeElement.disabled) sendGuess();
        else if (activeElement.id === "create-player-name") createRoom();
        else if (activeElement.id === "join-player-name" || activeElement.id === "join-room-code") joinExistingRoom();
        // Adicionar para inputs de palavra se desejar submeter com Enter (n√£o recomendado para m√∫ltiplos inputs)
      }
    });
    const joinRoomCodeEl = document.getElementById("join-room-code");
    if(joinRoomCodeEl) {
        joinRoomCodeEl.addEventListener("input", function(event) {
            event.target.value = event.target.value.toUpperCase();
        });
    }

    showScreen("initial-section");
  </script>
</body>
</html>
